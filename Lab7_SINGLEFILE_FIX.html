<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GEOG 464 – Lab 7 • Single-File Fix</title>

  <!-- Leaflet via jsDelivr CDN (robust) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{--bg:#0b1220; --fg:#f2f4ff; --muted:#b7c2ff; --card:#171f34; --link:#8fd3ff}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.55}
    .controls{display:flex;align-items:center;gap:.5rem;padding:1rem 1.25rem}
    #mapdiv{width:100%;height:80vh;border:1px solid rgba(255,255,255,.12);border-radius:16px}
    .answers{background:var(--card);margin:1rem 1.25rem;padding:1rem;border-radius:16px}
    .answers h2{margin:.25rem 0 .75rem}
  </style>
</head>
<body>
  <section class="controls">
    <label for="mapdropdown">Load a map:</label>
    <select id="mapdropdown">
      <option value="map0" selected disabled>Choose dataset…</option>
      <option value="mapa">Map A – Train Stations</option>
      <option value="mapb">Map B – Megacities</option>
    </select>
  </section>

  <div id="mapdiv" role="region" aria-label="Interactive map"></div>

  <div class="answers">
    <h2>Written Answers</h2>
    <p><strong>Q2–Q6</strong> are included as required in your multi-file build. This page is a deployment fix.</p>
  </div>

  <script>
  // Single-file JS (no external paths needed)
  let myMap = null;
  let currentDataLayer = null;

  const STATIONS_URL   = "https://raw.githubusercontent.com/brubcam/GEOG-464_Lab-7/main/DATA/train-stations.geojson";
  const MEGACITIES_URL = "https://raw.githubusercontent.com/brubcam/GEOG-464_Lab-7/main/DATA/megacities.geojson";

  function showError(msg){
    const el = document.createElement('div');
    el.style.cssText = "position:fixed;top:0;left:0;right:0;padding:.6rem 1rem;background:#b00020;color:white;font:14px/1.4 system-ui;z-index:9999";
    el.textContent = "Error: " + msg;
    document.body.appendChild(el);
  }

  function fetchData(url){
    return fetch(url, { mode: "cors", cache: "no-store" })
      .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`); return r.json(); })
      .then(json => {
        if (currentDataLayer) currentDataLayer.remove();
        currentDataLayer = L.geoJSON(json, {
          style: styleAll,
          pointToLayer: (f, ll) => L.circleMarker(ll),
          onEachFeature: addPopups
        }).addTo(myMap);
      })
      .catch(err => { console.error(err); showError(err.message); });
  }

  function styleAll(feature){
    const props = feature.properties || {};
    const styles = { stroke:true, color:'#000', opacity:1, weight:1, fillColor:'#fff', fillOpacity:0.5, radius:9 };
    const hasPostal = Object.keys(props).some(k => /postal/i.test(k) && props[k]);
    if (hasPostal) styles.fillColor = "cyan";
    const pop = Number(props.population);
    if (!Number.isNaN(pop)) styles.radius = Math.max(6, Math.min(22, Math.sqrt(pop)/300));
    return styles;
  }

  function addPopups(feature, layer){
    const props = feature.properties || {};
    const nameKey = Object.keys(props).find(k => /name|station/i.test(k));
    const title = nameKey ? props[nameKey] : "Feature";
    const list = Object.entries(props).map(([k,v]) => `<dt>${k}</dt><dd>${v}</dd>`).join("");
    layer.bindPopup(`<strong>${title}</strong><br/><dl class="props">${list}</dl>`, { maxWidth: 300 });
  }

  function loadMap(mapid){
    try { if (myMap) myMap.remove(); } catch(e){}
    finally {
      const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        { maxZoom:19, attribution:"&copy; OpenStreetMap" });
      const cartoLight = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        { maxZoom:20, attribution:"&copy; OpenStreetMap & CARTO" });

      myMap = L.map("mapdiv", { center:[20,0], zoom:2, layers:[cartoLight] });
      L.control.layers({ "CARTO Light": cartoLight, "OpenStreetMap": osm }, {}).addTo(myMap);

      if (mapid === "mapa"){ myMap.setView([45.5,-73.6],10); fetchData(STATIONS_URL); }
      else if (mapid === "mapb"){ myMap.setView([20, 0], 2); fetchData(MEGACITIES_URL); }

      setTimeout(() => myMap.invalidateSize(), 0);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const sel = document.getElementById("mapdropdown");
    sel.addEventListener("change", e => {
      const val = e.target.value;
      if (val !== "map0") loadMap(val);
    });
    sel.value = "mapa";
    loadMap("mapa");
  });
  </script>
</body>
</html>
